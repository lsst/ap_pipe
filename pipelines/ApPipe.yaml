description: End to end Alert Production pipeline
# Look in subdirectories of $AP_PIPE_DIR/pipelines to find customized pipelines
# for each camera. Those pipelines import this general AP pipeline.
#
# NOTES
# Remember to run make_apdb.py and use the same configs for diaPipe
# READ_UNCOMMITTED is required for sqlite APDBs, i.e.,
# -c diaPipe:apdb.isolation_level: 'READ_UNCOMMITTED'
# A db_url is always required, e.g.,
# -c diaPipe:apdb.db_url: 'sqlite:////project/user/association.db'
# Option to specify connection_timeout for sqlite APDBs encountering lock errors, i.e.,
# -c diaPipe:apdb.connection_timeout: 240

imports:
  - location: $AP_PIPE_DIR/pipelines/ProcessCcd.yaml
tasks:
    imageDifference:
        class: lsst.pipe.tasks.imageDifference.ImageDifferenceTask
    transformDiaSrcCat:
        class: lsst.ap.association.TransformDiaSourceCatalogTask
    diaPipe:
        class: lsst.ap.association.DiaPipelineTask
contracts:
    # DiaPipelineTask needs diaSource fluxes, catalogs, and difference exposures
    - imageDifference.doMeasurement is True
    - imageDifference.doWriteSources is True
    - imageDifference.doWriteSubtractedExp is True
    # Inputs and outputs must match
    - imageDifference.connections.coaddName == transformDiaSrcCat.connections.coaddName
    - imageDifference.connections.fakesType == transformDiaSrcCat.connections.fakesType
    - imageDifference.connections.coaddName == diaPipe.connections.coaddName
    - imageDifference.connections.fakesType == diaPipe.connections.fakesType
