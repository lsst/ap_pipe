description: End to end Alert Production pipeline
# Look in subdirectories of $AP_PIPE_DIR/pipelines to find customized pipelines
# for each camera. Those pipelines import this general AP pipeline.
#
# NOTES
# Remember to run make_apdb.py and use the same configs for diaPipe
# A db_url is always required, e.g.,
# -c diaPipe:apdb.db_url: 'sqlite:////project/user/association.db'
# Option to specify connection_timeout for sqlite APDBs encountering lock errors, i.e.,
# -c diaPipe:apdb.connection_timeout: 240

imports:
  - location: $AP_PIPE_DIR/pipelines/ProcessCcd.yaml
parameters:
  # Pipeline configurable to run on both goodSeeing and deep templates, depending on dataset.
  coaddName: goodSeeing
  # TODO: redundant connection definitions workaround for DM-30210
  template: goodSeeingCoadd
  diaSrcCat: goodSeeingDiff_diaSrc
  diaSrcSchema: goodSeeingDiff_diaSrc_schema
  diaSrcParquet: goodSeeingDiff_diaSrcTable
  diff: goodSeeingDiff_differenceExp
  diffScore: goodSeeingDiff_scoreExp
  diffWarp: goodSeeingDiff_warpedExp
  diffMatch: goodSeeingDiff_matchedExp
  assocSrc: goodSeeingDiff_assocDiaSrc
  templateExp: goodSeeingDiff_templateExp
  # TODO: end DM-30210 workaround
tasks:
  retrieveTemplate:  # For multi-tract difference imaging
    class: lsst.ip.diffim.getTemplate.GetTemplateTask
    config:
      connections.coaddName: parameters.coaddName
      connections.coaddExposures: parameters.template
      connections.outputExposure: parameters.templateExp
  imageDifference:
    class: lsst.pipe.tasks.imageDifference.ImageDifferenceFromTemplateTask
    config:
      doWriteWarpedExp: True             # Required for packaging alerts in diaPipe
      doSkySources: True
      coaddName: parameters.coaddName  # Can be removed once ImageDifference no longer supports Gen 2
      connections.coaddName: parameters.coaddName
      # TODO: redundant connection definitions workaround for DM-30210
      connections.coaddExposures: parameters.template
      connections.dcrCoadds: dcrCoadd
      connections.outputSchema: parameters.diaSrcSchema
      connections.subtractedExposure: parameters.diff
      connections.scoreExposure: parameters.diffScore
      connections.warpedExposure: parameters.diffWarp
      connections.matchedExposure: parameters.diffMatch
      connections.diaSources: parameters.diaSrcCat
      connections.inputTemplate: parameters.templateExp
      # TODO: end DM-30210 workaround
  transformDiaSrcCat:
    class: lsst.ap.association.TransformDiaSourceCatalogTask
    config:
      doRemoveSkySources: True
      connections.coaddName: parameters.coaddName
      # TODO: redundant connection definitions workaround for DM-30210
      connections.diaSourceSchema: parameters.diaSrcSchema
      connections.diaSourceCat: parameters.diaSrcCat
      connections.diffIm: parameters.diff
      connections.diaSourceTable: parameters.diaSrcParquet
      # TODO: end DM-30210 workaround
  diaPipe:
    class: lsst.ap.association.DiaPipelineTask
    config:
      connections.coaddName: parameters.coaddName
      # TODO: redundant connection definitions workaround for DM-30210
      connections.diaSourceTable: parameters.diaSrcParquet
      connections.diffIm: parameters.diff
      connections.warpedExposure: parameters.diffWarp
      connections.associatedDiaSources: parameters.assocSrc
      # TODO: end DM-30210 workaround
subsets:
  apPipe:
    subset:
      - isr
      - characterizeImage
      - calibrate
      - retrieveTemplate
      - imageDifference
      - transformDiaSrcCat
      - diaPipe
    description: >
      An alias of ApPipe to use in higher-level pipelines.
contracts:
  # DiaPipelineTask needs diaSource fluxes, catalogs, warped exposures, and difference exposures
  - imageDifference.doMeasurement is True
  - imageDifference.doWriteSources is True
  - imageDifference.doWriteWarpedExp is True
  - imageDifference.doWriteSubtractedExp is True
  - imageDifference.doSkySources == transformDiaSrcCat.doRemoveSkySources
  # Inputs and outputs must match
  - retrieveTemplate.connections.outputExposure == imageDifference.connections.inputTemplate
  - imageDifference.connections.coaddName == transformDiaSrcCat.connections.coaddName
  - imageDifference.connections.fakesType == transformDiaSrcCat.connections.fakesType
  - imageDifference.connections.coaddName == diaPipe.connections.coaddName
  - imageDifference.connections.fakesType == diaPipe.connections.fakesType
  - transformDiaSrcCat.connections.diaSourceTable == diaPipe.connections.diaSourceTable
