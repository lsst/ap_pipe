description: End to end Alert Production pipeline
# Look in subdirectories of $AP_PIPE_DIR/pipelines to find customized pipelines
# for each camera. Those pipelines import this general AP pipeline.
#
# NOTES
# Remember to run make_apdb.py and use the same configs for diaPipe
# READ_UNCOMMITTED is required for sqlite APDBs, i.e.,
# -c diaPipe:apdb.isolation_level: 'READ_UNCOMMITTED'
# A db_url is always required, e.g.,
# -c diaPipe:apdb.db_url: 'sqlite:////project/user/association.db'
# Option to specify connection_timeout for sqlite APDBs encountering lock errors, i.e.,
# -c diaPipe:apdb.connection_timeout: 240

imports:
  - location: $AP_PIPE_DIR/pipelines/ProcessCcd.yaml
tasks:
  imageDifference:
    class: lsst.pipe.tasks.imageDifference.ImageDifferenceTask
    config:
      doWriteWarpedExp: True             # Required for packaging alerts in diaPipe
      doSkySources: True
      # 'goodSeeing' expected type for LSST processing; task default 'deep' for Gen 2 pipelines
      coaddName: goodSeeing              # Can be removed once ImageDifference no longer supports Gen 2
      getTemplate.coaddName: goodSeeing  # Can be removed once ImageDifference no longer supports Gen 2
      connections.coaddName: goodSeeing
      # TODO: redundant connection definitions workaround for DM-30210
      connections.exposure: calexp
      connections.coaddExposures: goodSeeingCoadd
      connections.dcrCoadds: dcrCoadd
      connections.outputSchema: goodSeeingDiff_diaSrc_schema
      connections.subtractedExposure: goodSeeingDiff_differenceExp
      connections.scoreExposure: goodSeeingDiff_scoreExp
      connections.warpedExposure: goodSeeingDiff_warpedExp
      connections.matchedExposure: goodSeeingDiff_matchedExp
      connections.diaSources: goodSeeingDiff_diaSrc
      # TODO: end DM-30210 workaround
  transformDiaSrcCat:
    class: lsst.ap.association.TransformDiaSourceCatalogTask
    config:
      doRemoveSkySources: True
      connections.coaddName: goodSeeing
      # TODO: redundant connection definitions workaround for DM-30210
      connections.diaSourceSchema: goodSeeingDiff_diaSrc_schema
      connections.diaSourceCat: goodSeeingDiff_diaSrc
      connections.diffIm: goodSeeingDiff_differenceExp
      connections.diaSourceTable: goodSeeingDiff_diaSrcTable
      # TODO: end DM-30210 workaround
  diaPipe:
    class: lsst.ap.association.DiaPipelineTask
    config:
      connections.coaddName: goodSeeing
      # TODO: redundant connection definitions workaround for DM-30210
      connections.diaSourceTable: goodSeeingDiff_diaSrcTable
      connections.diffIm: goodSeeingDiff_differenceExp
      connections.warpedExposure: goodSeeingDiff_warpedExp
      connections.associatedDiaSources: goodSeeingDiff_assocDiaSrcTable
      # TODO: end DM-30210 workaround
contracts:
  # DiaPipelineTask needs diaSource fluxes, catalogs, warped exposures, and difference exposures
  - imageDifference.doMeasurement is True
  - imageDifference.doWriteSources is True
  - imageDifference.doWriteWarpedExp is True
  - imageDifference.doWriteSubtractedExp is True
  - imageDifference.doSkySources == transformDiaSrcCat.doRemoveSkySources
  # Inputs and outputs must match
  - imageDifference.connections.coaddName == transformDiaSrcCat.connections.coaddName
  - imageDifference.connections.fakesType == transformDiaSrcCat.connections.fakesType
  - imageDifference.connections.coaddName == diaPipe.connections.coaddName
  - imageDifference.connections.fakesType == diaPipe.connections.fakesType
  - transformDiaSrcCat.connections.diaSourceTable == diaPipe.connections.diaSourceTable
